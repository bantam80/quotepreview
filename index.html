<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Quote Preview & Gatekeeper</title>
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f5f7; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }
        .header h2 { margin: 0; color: #2c3e50; }
        .doc-info { text-align: right; font-size: 14px; color: #777; }
        
        .section-title { font-size: 16px; font-weight: bold; margin: 20px 0 10p<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Quote Preview & Gatekeeper</title>
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f5f7; padding: 20px; color: #333; }
        
        /* CONTAINER & HEADER */
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }
        .header h2 { margin: 0; color: #2c3e50; }
        .doc-info { text-align: right; font-size: 14px; color: #777; }
        
        /* TABLES */
        .section-title { font-size: 16px; font-weight: bold; margin: 20px 0 10px; color: #444; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 14px; }
        th { background: #f8f9fa; color: #555; text-align: left; padding: 10px; border-bottom: 2px solid #ddd; font-weight: 600; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .col-qty { width: 60px; text-align: center; }
        .col-money { width: 100px; text-align: right; }
        .total-row td { font-weight: bold; background-color: #fdfdfd; border-top: 2px solid #ddd; color: #000; }
        
        /* BADGES */
        .badge-included { background: #e6f4ea; color: #1e7e34; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-excess { background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        
        /* ACTION BAR */
        .action-bar { margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        button { padding: 12px 24px; border: none; border-radius: 5px; font-size: 15px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .btn-restart { background-color: #fff; border: 2px solid #dc3545; color: #dc3545; }
        .btn-restart:hover { background-color: #dc3545; color: white; }
        .btn-save { background-color: #28a745; color: white; display: flex; align-items: center; gap: 8px; }
        .btn-save:hover { background-color: #218838; }
        
        /* LOADER */
        #loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 999; text-align: center; padding-top: 200px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .version-footer { text-align: center; margin-top: 20px; font-size: 12px; color: #999; opacity: 0.6; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <h3 id="loaderText">Processing...</h3>
</div>

<div class="container" id="quoteContainer">
    <div class="header">
        <h2>Quote Preview</h2>
        <div class="doc-info">
            <div id="dealNameDisplay">Deal Name</div>
            <div id="dateDisplay">Date: --/--/----</div>
        </div>
    </div>

    <div class="section-title">Monthly Recurring Charges (MRC)</div>
    <table id="mrcTable">
        <thead>
            <tr><th>Item</th><th class="col-qty">Qty</th><th class="col-money">Rate</th><th class="col-money">Total</th></tr>
        </thead>
        <tbody id="mrcBody"></tbody>
        <tfoot>
            <tr class="total-row"><td colspan="3" style="text-align:right;">TOTAL MONTHLY:</td><td class="col-money" id="totalMrcDisplay">$0.00</td></tr>
        </tfoot>
    </table>

    <div class="section-title" style="margin-top: 30px;">One-Time Charges (NRC)</div>
    <table id="nrcTable">
        <thead>
            <tr><th>Item</th><th class="col-qty">Qty</th><th class="col-money">Rate</th><th class="col-money">Total</th></tr>
        </thead>
        <tbody id="nrcBody"></tbody>
        <tfoot>
            <tr class="total-row"><td colspan="3" style="text-align:right;">TOTAL ONE-TIME:</td><td class="col-money" id="totalNrcDisplay">$0.00</td></tr>
        </tfoot>
    </table>
</div>

<div class="container" style="margin-top: 15px; background: transparent; box-shadow: none; padding: 0;">
    <div class="action-bar">
        <button class="btn-restart" onclick="handleStartOver()">&#8634; Start Over</button>
        <button class="btn-save" id="btnSave" onclick="handleSaveAndFinish()"><span>Save PDF & Finish</span> <span>&#10140;</span></button>
    </div>
    <div class="version-footer">Widget Version: V4</div>
</div>

<script>
    /* =================================================================
       GLOBAL VARIABLES
       ================================================================= */
    var dealId = null;
    var dealRecord = {}; 
    var lineItems = { mrc: [], nrc: [] };

    // BUTTON CONFIGURATION
    const RESTART_TRANSITION_NAME = "Solution Design"; 
    const PROCEED_TRANSITION_NAME = "Proceed"; 

    // FIELDS TO KEEP (SAFE LIST)
    const SAFE_FIELDS = [
        "Form_Update_Key", "VoiceOS_Other", "Questionnaire_Link", "Opp_Created_Time",
        "Deal_Name", "Pipeline", "Stage", "Closing_Date", "Account_Name", "Owner", 
        "Probability", "End_Customer", "Next_Step", "id", "Created_Time", 
        "Modified_Time", "Created_By", "Modified_By", "Tag", "Layout", "Wizard_Dependency"
    ];

    // PRODUCT ID MAP (Source: CreateQuoteCodeR2)
    const ID_MAP = {
        "VMTRANS": "1231536000013241029", "ENHCLID": "1231536000013499025", "E911": "1231536000013499026",
        "SIP_TRUNK": "1231536000013499027", "SIP_PRI": "1231536000013241014", "SIP_BACK": "1231536000013499028",
        "UC_STD": "1231536000009612019", "UC_ADV": "1231536000009612022", "UC_CC": "1231536000009612025",
        "POTS": "1231536000013241011", "WEBFAX": "1231536000013241043", "T38": "1231536000013241017",
        "TEAMS_SIP": "1231536000013241023", "TEAMS_PBX": "1231536000013241020", "FAX_EMAIL": "1231536000013241026",
        "ONB_ADV": "1231536000009612029", "ONB_STD": "1231536000009612028", "ONB_CC": "1231536000009612030",
        "ONB_POTS": "1231536000013241066", "SITE_SURVEY": "1231536000013499030", "LABOR": "1231536000013235207",
        "DID_LOCAL": "1231536000013261029", "DID_TF": "1231536000013261030",
        "LNP_LOCAL": "1231536000013261027", "LNP_TF": "1231536000013261028"
    };

    // MRC CONFIGURATION MAP
    const MRC_CONFIG = {
        "Voicemail_Transcription": "VMTRANS", "Enhanced_Caller_ID": "ENHCLID", "E911_Locations": "E911",
        "SIP_Trunks_Qty": "SIP_TRUNK", "TTL_SIP_Trunks_Primary": "SIP_PRI", "TTL_SIP_Trunks_Backup": "SIP_BACK",
        "Standard_Qty": "UC_STD", "Advanced_Qty": "UC_ADV", "Contact_Center_Qty": "UC_CC",
        "POTS_for_Paging_Qty": "POTS", "Webfax": "WEBFAX", "T_38_Fax": "T38",
        "MS_Teams_SIP": "TEAMS_SIP", "MS_Teams_PBX": "TEAMS_PBX", "Fax_to_Email": "FAX_EMAIL"
    };

    // SETUP / ONBOARDING CONFIGURATION MAP
    const SETUP_CONFIG = {
        "Advanced_Qty": "ONB_ADV", "Standard_Qty": "ONB_STD", "Contact_Center_Qty": "ONB_CC",
        "Analog_Line_Count": "ONB_POTS", "POTS_for_Paging_Qty": "ONB_POTS", "Webfax": "ONB_ADV",
        "T_38_Fax": "ONB_POTS", "MS_Teams_SIP": "ONB_ADV", "MS_Teams_PBX": "ONB_ADV",
        "Fax_to_Email": "ONB_STD"
    };

    // ENTITLEMENT ORDER LIST
    const ENTITLEMENT_LIST = [
        { field: "New_DID", key: "DID_LOCAL" }, 
        { field: "Porting_DID", key: "LNP_LOCAL" },
        { field: "New_TFN", key: "DID_TF" }, 
        { field: "Porting_TFN", key: "LNP_TF" }
    ];
    
    // EXCESS RATES
    const EXCESS_MRC_RATE = 1.00;
    const EXCESS_NRC_RATE = 2.00;

    /* =================================================================
       INITIALIZATION
       ================================================================= */
    ZOHO.embeddedApp.on("PageLoad", function(data){
        console.log("Widget PageLoad", data);
        if(data && data.EntityId) {
            dealId = Array.isArray(data.EntityId) ? data.EntityId[0] : data.EntityId;
            initWidget();
        }
    });

    ZOHO.embeddedApp.init().then(function(){
        console.log("Zoho SDK Init Success");
    });

    function initWidget() {
        document.getElementById("dateDisplay").innerText = "Date: " + new Date().toLocaleDateString();
        showLoader(true, "Loading Deal Data...");
        
        ZOHO.CRM.API.getRecord({ Entity: "Deals", RecordID: dealId })
        .then(function(response){
            if(response.data) {
                dealRecord = response.data[0];
                console.log("Deal Data Loaded", dealRecord);
                document.getElementById("dealNameDisplay").innerText = dealRecord.Deal_Name;
                calculateQuote();
            } else {
                console.error("No data in response");
            }
        })
        .catch(function(err){
            console.error("Deal Fetch Error", err);
        });
    }

    /* =================================================================
       CALCULATION LOGIC
       ================================================================= */
    async function calculateQuote() {
        lineItems = { mrc: [], nrc: [] };
        console.log("Starting Calculation...");
        
        // 1. BUILD PRODUCT FETCH QUEUE
        let productsToFetch = new Set();
        const queue = (key) => { if(ID_MAP[key]) productsToFetch.add(ID_MAP[key]); };

        // Scan Maps
        for(let f in MRC_CONFIG) { if(getVal(f) > 0 || getVal(f) === "Yes") queue(MRC_CONFIG[f]); }
        for(let f in SETUP_CONFIG) { if(getVal(f) > 0) queue(SETUP_CONFIG[f]); }
        ENTITLEMENT_LIST.forEach(e => { if(getVal(e.field) > 0) queue(e.key); });
        
        // Scan Hardware
        let phoneSubform = dealRecord.Phone_Hardware || [];
        phoneSubform.forEach(row => { if(row.Phone_Selection) productsToFetch.add(row.Phone_Selection.id); });
        
        // Scan Labor
        queue("SITE_SURVEY"); queue("LABOR");

        // 2. BATCH FETCH PRICES
        let priceMap = {};
        console.log("Fetching Products:", productsToFetch.size);
        
        let fetchPromises = Array.from(productsToFetch).map(id => 
            ZOHO.CRM.API.getRecord({ Entity: "Products", RecordID: id }).then(r => {
                if(r.data && r.data[0]) {
                    priceMap[id] = { name: r.data[0].Product_Name, price: r.data[0].Unit_Price || 0 };
                }
            }).catch(e => console.log("Prod fetch fail", id))
        );
        
        await Promise.all(fetchPromises);
        console.log("Price Map Built", priceMap);

        // 3. GENERATE LINE ITEMS

        // A. MRC ITEMS (Looping MRC_CONFIG)
        for(let field in MRC_CONFIG) {
            let val = getVal(field);
            let qty = (val === "Yes" || val === true) ? 1 : parseFloat(val || 0);
            let key = MRC_CONFIG[field];
            if(qty > 0 && ID_MAP[key] && priceMap[ID_MAP[key]]) {
                // Check if this field ALSO has an onboarding fee (for sorting)
                let hasOnboarding = (SETUP_CONFIG[field] !== undefined);
                
                lineItems.mrc.push({ 
                    name: priceMap[ID_MAP[key]].name, 
                    qty: qty, 
                    price: priceMap[ID_MAP[key]].price,
                    hasOnboarding: hasOnboarding 
                });
            }
        }

        // B. SETUP / ONBOARDING ITEMS (Looping SETUP_CONFIG)
        for(let field in SETUP_CONFIG) {
            let qty = parseFloat(getVal(field) || 0);
            let key = SETUP_CONFIG[field];
            if(qty > 0 && ID_MAP[key] && priceMap[ID_MAP[key]]) {
                lineItems.nrc.push({ 
                    name: priceMap[ID_MAP[key]].name + " (Setup)", 
                    qty: qty, 
                    price: priceMap[ID_MAP[key]].price 
                });
            }
        }

        // C. ENTITLEMENTS (Strict Bucket Order)
        let remEnt = parseFloat(getVal("TN_Entitlements") || 0);
        console.log("Entitlement Bucket Start:", remEnt);

        ENTITLEMENT_LIST.forEach(item => {
            let qty = parseFloat(getVal(item.field) || 0);
            let prodId = ID_MAP[item.key];

            if(qty > 0 && prodId && priceMap[prodId]) {
                let freeQty = 0;
                let paidQty = 0;

                // Determine Split
                if(qty <= remEnt) { 
                    freeQty = qty; 
                    remEnt -= qty; 
                } else { 
                    freeQty = remEnt; 
                    paidQty = qty - remEnt; 
                    remEnt = 0; 
                }
                
                let pName = priceMap[prodId].name;

                // 1. FREE PORTION (Within Entitlement) -> Add to MRC ($0) and NRC ($0)
                if(freeQty > 0) {
                    lineItems.mrc.push({ name: pName, qty: freeQty, price: 0, isEntitlement: true, hasOnboarding: false });
                    lineItems.nrc.push({ name: pName, qty: freeQty, price: 0, isEntitlement: true });
                }

                // 2. PAID PORTION (Excess) -> Add to MRC ($1.00) and NRC ($2.00)
                if(paidQty > 0) {
                    lineItems.mrc.push({ name: pName, qty: paidQty, price: EXCESS_MRC_RATE, isExcess: true, hasOnboarding: false });
                    lineItems.nrc.push({ name: pName, qty: paidQty, price: EXCESS_NRC_RATE, isExcess: true });
                }
            }
        });

        // D. HARDWARE
        phoneSubform.forEach(row => {
            let pid = row.Phone_Selection ? row.Phone_Selection.id : null;
            let qty = parseFloat(row.Phone_Qty || 0);
            if(pid && qty > 0 && priceMap[pid]) {
                lineItems.nrc.push({ name: priceMap[pid].name, qty: qty, price: priceMap[pid].price });
            }
        });

        // E. LABOR & SURVEY
        let analogCount = parseFloat(getVal("Analog_Line_Count")||0) + parseFloat(getVal("POTS_for_Paging_Qty")||0) + parseFloat(getVal("T_38_Fax")||0);
        if(analogCount > 0 && ID_MAP["SITE_SURVEY"]) {
            let sId = ID_MAP["SITE_SURVEY"];
            if(priceMap[sId]) lineItems.nrc.push({ name: priceMap[sId].name, qty: 1, price: priceMap[sId].price });
        }

        let totalPhones = phoneSubform.reduce((sum, r) => sum + parseFloat(r.Phone_Qty||0), 0);
        if(getVal("On_Site_Install") === "Yes" && totalPhones > 0 && ID_MAP["LABOR"]) {
            let lId = ID_MAP["LABOR"];
            if(priceMap[lId]) {
                let laborUnits = Math.ceil(totalPhones / 5.0);
                lineItems.nrc.push({ name: priceMap[lId].name, qty: laborUnits, price: priceMap[lId].price });
            }
        }

        renderTables();
        showLoader(false);
    }

    function getVal(key) { return dealRecord[key]; }

    /* =================================================================
       RENDER & ACTIONS
       ================================================================= */
    function renderTables() {
        
        // SORT MRC: Items with onboarding fees go to the top
        lineItems.mrc.sort((a, b) => {
            return (b.hasOnboarding ? 1 : 0) - (a.hasOnboarding ? 1 : 0);
        });

        let renderRows = (list, bodyId, totalId) => {
            let html = "", totalVal = 0;
            if(list.length === 0) html = "<tr><td colspan='4' style='color:#999; text-align:center;'>No Items</td></tr>";
            list.forEach(item => {
                let lineTotal = item.qty * item.price;
                totalVal += lineTotal;
                let badge = "";
                if(item.isEntitlement) badge = " <span class='badge-included'>Included</span>";
                if(item.isExcess) badge = " <span class='badge-excess'>Excess</span>";
                
                html += `<tr><td>${item.name}${badge}</td><td class="col-qty">${item.qty}</td>
                         <td class="col-money">$${item.price.toFixed(2)}</td><td class="col-money">$${lineTotal.toFixed(2)}</td></tr>`;
            });
            document.getElementById(bodyId).innerHTML = html;
            document.getElementById(totalId).innerText = "$" + totalVal.toFixed(2);
        };
        renderRows(lineItems.mrc, "mrcBody", "totalMrcDisplay");
        renderRows(lineItems.nrc, "nrcBody", "totalNrcDisplay");
    }

    function handleSaveAndFinish() {
        if(!confirm("Proceed with this Quote?")) return;
        
        // Safety check if dealRecord is loaded
        if(!dealRecord || !dealRecord.Deal_Name) {
            alert("Error: Deal data not fully loaded. Please refresh.");
            return;
        }

        showLoader(true, "Generating PDF...");
        let element = document.getElementById('quoteContainer');
        let filename = (dealRecord.Deal_Name || "Quote").replace(/[^a-z0-9]/gi, '_') + " - V1.pdf";
        
        let opt = {
            margin:       0.5,
            filename:     filename,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).outputPdf('blob').then(function(b) {
            uploadToCRM(b, filename);
        });
    }

    function uploadToCRM(blob, filename) {
        document.getElementById("loaderText").innerText = "Uploading PDF...";
        let file = new File([blob], filename, { type: "application/pdf" });
        ZOHO.CRM.API.attachFile({ Entity: "Deals", RecordID: dealId, File: { file_obj: file } })
        .then(function() {
            document.getElementById("loaderText").innerText = "Advancing Blueprint...";
            ZOHO.CRM.BLUEPRINT.proceed({ transition_id: PROCEED_TRANSITION_NAME, data: {} }).then(function() {
                ZOHO.CRM.UI.Popup.closeReload();
            });
        })
        .catch(function(err) { 
            alert("Error: " + JSON.stringify(err)); 
            showLoader(false); 
        });
    }

    function handleStartOver() {
        if(!confirm("Clear all data and Start Over?")) return;
        showLoader(true, "Clearing Records...");
        let updateMap = {};
        for (let key in dealRecord) {
            if (!key.startsWith("$") && !SAFE_FIELDS.includes(key) && dealRecord[key] !== null) {
                updateMap[key] = null;
            }
        }
        updateMap["Phone_Hardware"] = []; 
        ZOHO.CRM.API.updateRecord({ Entity: "Deals", APIData: { id: dealId, ...updateMap } })
        .then(function() {
            // Updated to 'Solution Design'
            ZOHO.CRM.BLUEPRINT.proceed({ transition_id: RESTART_TRANSITION_NAME, data: {} }).then(function() {
                ZOHO.CRM.UI.Popup.closeReload();
            });
        });
    }

    function showLoader(v, t) { 
        document.getElementById("loader").style.display = v?"block":"none"; 
        if(t) document.getElementById("loaderText").innerText = t; 
    }
</script>
</body>
</html>x; color: #444; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 14px; }
        th { background: #f8f9fa; color: #555; text-align: left; padding: 10px; border-bottom: 2px solid #ddd; font-weight: 600; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        .col-qty { width: 60px; text-align: center; }
        .col-money { width: 100px; text-align: right; }
        .total-row td { font-weight: bold; background-color: #fdfdfd; border-top: 2px solid #ddd; color: #000; }
        
        /* Badges */
        .badge-included { background: #e6f4ea; color: #1e7e34; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-excess { background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        
        /* Action Bar */
        .action-bar { margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        button { padding: 12px 24px; border: none; border-radius: 5px; font-size: 15px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .btn-restart { background-color: #fff; border: 2px solid #dc3545; color: #dc3545; }
        .btn-restart:hover { background-color: #dc3545; color: white; }
        .btn-save { background-color: #28a745; color: white; display: flex; align-items: center; gap: 8px; }
        .btn-save:hover { background-color: #218838; }
        
        /* Loading & Footer */
        #loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 999; text-align: center; padding-top: 200px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .version-footer { text-align: center; margin-top: 20px; font-size: 12px; color: #999; opacity: 0.6; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <h3 id="loaderText">Processing...</h3>
</div>

<div class="container" id="quoteContainer">
    <div class="header">
        <h2>Quote Preview</h2>
        <div class="doc-info">
            <div id="dealNameDisplay">Deal Name</div>
            <div id="dateDisplay">Date: --/--/----</div>
        </div>
    </div>

    <div class="section-title">Monthly Recurring Charges (MRC)</div>
    <table id="mrcTable">
        <thead>
            <tr><th>Item</th><th class="col-qty">Qty</th><th class="col-money">Rate</th><th class="col-money">Total</th></tr>
        </thead>
        <tbody id="mrcBody"></tbody>
        <tfoot>
            <tr class="total-row"><td colspan="3" style="text-align:right;">TOTAL MONTHLY:</td><td class="col-money" id="totalMrcDisplay">$0.00</td></tr>
        </tfoot>
    </table>

    <div class="section-title" style="margin-top: 30px;">One-Time Charges (NRC)</div>
    <table id="nrcTable">
        <thead>
            <tr><th>Item</th><th class="col-qty">Qty</th><th class="col-money">Rate</th><th class="col-money">Total</th></tr>
        </thead>
        <tbody id="nrcBody"></tbody>
        <tfoot>
            <tr class="total-row"><td colspan="3" style="text-align:right;">TOTAL ONE-TIME:</td><td class="col-money" id="totalNrcDisplay">$0.00</td></tr>
        </tfoot>
    </table>
</div>

<div class="container" style="margin-top: 15px; background: transparent; box-shadow: none; padding: 0;">
    <div class="action-bar">
        <button class="btn-restart" onclick="handleStartOver()">&#8634; Start Over</button>
        <button class="btn-save" id="btnSave" onclick="handleSaveAndFinish()"><span>Save PDF & Finish</span> <span>&#10140;</span></button>
    </div>
    <div class="version-footer">Widget Version: V3</div>
</div>

<script>
    // --- CONFIGURATION ---
    const RESTART_TRANSITION_NAME = "Restart"; 
    const PROCEED_TRANSITION_NAME = "Proceed"; 

    // FIELDS TO KEEP (Source: WipeRecord.txt)
    const SAFE_FIELDS = [
        "Form_Update_Key", "VoiceOS_Other", "Questionnaire_Link", "Opp_Created_Time",
        "Deal_Name", "Pipeline", "Stage", "Closing_Date", "Account_Name", "Owner", 
        "Probability", "End_Customer", "Next_Step", "id", "Created_Time", 
        "Modified_Time", "Created_By", "Modified_By", "Tag", "Layout", "Wizard_Dependency"
    ];

    // PRODUCT ID MAP (Source: CreateQuoteCodeR2.txt)
    const ID_MAP = {
        "VMTRANS": "1231536000013241029", "ENHCLID": "1231536000013499025", "E911": "1231536000013499026",
        "SIP_TRUNK": "1231536000013499027", "SIP_PRI": "1231536000013241014", "SIP_BACK": "1231536000013499028",
        "UC_STD": "1231536000009612019", "UC_ADV": "1231536000009612022", "UC_CC": "1231536000009612025",
        "POTS": "1231536000013241011", "WEBFAX": "1231536000013241043", "T38": "1231536000013241017",
        "TEAMS_SIP": "1231536000013241023", "TEAMS_PBX": "1231536000013241020", "FAX_EMAIL": "1231536000013241026",
        "ONB_ADV": "1231536000009612029", "ONB_STD": "1231536000009612028", "ONB_CC": "1231536000009612030",
        "ONB_POTS": "1231536000013241066", "SITE_SURVEY": "1231536000013499030", "LABOR": "1231536000013235207",
        "DID_LOCAL": "1231536000013261029", "DID_TF": "1231536000013261030",
        "LNP_LOCAL": "1231536000013261027", "LNP_TF": "1231536000013261028"
    };

    [cite_start]// MRC CONFIGURATION [cite: 105-106]
    const MRC_CONFIG = {
        "Voicemail_Transcription": "VMTRANS", "Enhanced_Caller_ID": "ENHCLID", "E911_Locations": "E911",
        "SIP_Trunks_Qty": "SIP_TRUNK", "TTL_SIP_Trunks_Primary": "SIP_PRI", "TTL_SIP_Trunks_Backup": "SIP_BACK",
        "Standard_Qty": "UC_STD", "Advanced_Qty": "UC_ADV", "Contact_Center_Qty": "UC_CC",
        "POTS_for_Paging_Qty": "POTS", "Webfax": "WEBFAX", "T_38_Fax": "T38",
        "MS_Teams_SIP": "TEAMS_SIP", "MS_Teams_PBX": "TEAMS_PBX", "Fax_to_Email": "FAX_EMAIL"
    };

    [cite_start]// SETUP / ONBOARDING CONFIGURATION [cite: 106, 112]
    const SETUP_CONFIG = {
        "Advanced_Qty": "ONB_ADV", "Standard_Qty": "ONB_STD", "Contact_Center_Qty": "ONB_CC",
        "Analog_Line_Count": "ONB_POTS", "POTS_for_Paging_Qty": "ONB_POTS", "Webfax": "ONB_ADV",
        "T_38_Fax": "ONB_POTS", "MS_Teams_SIP": "ONB_ADV", "MS_Teams_PBX": "ONB_ADV",
        "Fax_to_Email": "ONB_STD"
    };

    [cite_start]// ENTITLEMENT ORDER [cite: 117-120]
    // The specific order items consume the bucket
    const ENTITLEMENT_LIST = [
        { field: "New_DID", key: "DID_LOCAL" }, 
        { field: "Porting_DID", key: "LNP_LOCAL" },
        { field: "New_TFN", key: "DID_TF" }, 
        { field: "Porting_TFN", key: "LNP_TF" }
    ];
    
    // EXCESS RATES
    const EXCESS_MRC_RATE = 1.00;
    const EXCESS_NRC_RATE = 2.00;

    // --- STATE ---
    let dealId = null;
    let dealRecord = {};
    let lineItems = { mrc: [], nrc: [] };

    // --- INITIALIZATION ---
    ZOHO.embeddedApp.on("PageLoad", function(data){
        if(data && data.EntityId) {
            dealId = Array.isArray(data.EntityId) ? data.EntityId[0] : data.EntityId;
            initWidget();
        }
    });
    ZOHO.embeddedApp.init();

    function initWidget() {
        document.getElementById("dateDisplay").innerText = "Date: " + new Date().toLocaleDateString();
        showLoader(true, "Loading Deal Data...");
        ZOHO.CRM.API.getRecord({ Entity: "Deals", RecordID: dealId })
        .then(function(response){
            if(response.data) {
                dealRecord = response.data[0];
                document.getElementById("dealNameDisplay").innerText = dealRecord.Deal_Name;
                calculateQuote();
            }
        });
    }

    // --- CALCULATION ENGINE ---
    async function calculateQuote() {
        lineItems = { mrc: [], nrc: [] };
        
        // 1. BUILD PRODUCT FETCH QUEUE
        let productsToFetch = new Set();
        const queue = (key) => { if(ID_MAP[key]) productsToFetch.add(ID_MAP[key]); };

        for(let f in MRC_CONFIG) { if(getVal(f) > 0 || getVal(f) === "Yes") queue(MRC_CONFIG[f]); }
        for(let f in SETUP_CONFIG) { if(getVal(f) > 0) queue(SETUP_CONFIG[f]); }
        ENTITLEMENT_LIST.forEach(e => { if(getVal(e.field) > 0) queue(e.key); });
        
        let phoneSubform = dealRecord.Phone_Hardware || [];
        phoneSubform.forEach(row => { if(row.Phone_Selection) productsToFetch.add(row.Phone_Selection.id); });
        
        queue("SITE_SURVEY"); queue("LABOR");

        // 2. BATCH FETCH PRICES
        let priceMap = {};
        let fetchPromises = Array.from(productsToFetch).map(id => 
            ZOHO.CRM.API.getRecord({ Entity: "Products", RecordID: id }).then(r => {
                if(r.data && r.data[0]) priceMap[id] = { name: r.data[0].Product_Name, price: r.data[0].Unit_Price || 0 };
            }).catch(e => console.log("Prod fetch fail", id))
        );
        await Promise.all(fetchPromises);

        // 3. GENERATE LINE ITEMS

        // A. MRC ITEMS (Looping MRC_CONFIG)
        for(let field in MRC_CONFIG) {
            let val = getVal(field);
            let qty = (val === "Yes" || val === true) ? 1 : parseFloat(val || 0);
            let key = MRC_CONFIG[field];
            if(qty > 0 && ID_MAP[key] && priceMap[ID_MAP[key]]) {
                // Check if this field ALSO has an onboarding fee (for sorting purposes)
                let hasOnboarding = (SETUP_CONFIG[field] !== undefined);
                
                lineItems.mrc.push({ 
                    name: priceMap[ID_MAP[key]].name, 
                    qty: qty, 
                    price: priceMap[ID_MAP[key]].price,
                    hasOnboarding: hasOnboarding // FLAG FOR SORTING
                });
            }
        }

        // B. SETUP / ONBOARDING ITEMS (Looping SETUP_CONFIG)
        for(let field in SETUP_CONFIG) {
            let qty = parseFloat(getVal(field) || 0);
            let key = SETUP_CONFIG[field];
            if(qty > 0 && ID_MAP[key] && priceMap[ID_MAP[key]]) {
                lineItems.nrc.push({ 
                    name: priceMap[ID_MAP[key]].name + " (Setup)", 
                    qty: qty, 
                    price: priceMap[ID_MAP[key]].price 
                });
            }
        }

        // C. ENTITLEMENTS (Strict Bucket Order)
        let remEnt = parseFloat(getVal("TN_Entitlements") || 0);
        
        ENTITLEMENT_LIST.forEach(item => {
            let qty = parseFloat(getVal(item.field) || 0);
            let prodId = ID_MAP[item.key];

            if(qty > 0 && prodId && priceMap[prodId]) {
                let freeQty = 0;
                let paidQty = 0;

                // Determine Split
                if(qty <= remEnt) { 
                    freeQty = qty; 
                    remEnt -= qty; 
                } else { 
                    freeQty = remEnt; 
                    paidQty = qty - remEnt; 
                    remEnt = 0; 
                }
                
                let pName = priceMap[prodId].name;

                // 1. FREE PORTION (Within Entitlement)
                // Add to MRC ($0) and NRC ($0) so they are visible
                if(freeQty > 0) {
                    lineItems.mrc.push({ name: pName, qty: freeQty, price: 0, isEntitlement: true, hasOnboarding: false });
                    lineItems.nrc.push({ name: pName, qty: freeQty, price: 0, isEntitlement: true });
                }

                // 2. PAID PORTION (Excess)
                // Add to MRC ($1.00) and NRC ($2.00)
                if(paidQty > 0) {
                    lineItems.mrc.push({ name: pName, qty: paidQty, price: EXCESS_MRC_RATE, isExcess: true, hasOnboarding: false });
                    lineItems.nrc.push({ name: pName, qty: paidQty, price: EXCESS_NRC_RATE, isExcess: true });
                }
            }
        });

        // D. HARDWARE
        phoneSubform.forEach(row => {
            let pid = row.Phone_Selection ? row.Phone_Selection.id : null;
            let qty = parseFloat(row.Phone_Qty || 0);
            if(pid && qty > 0 && priceMap[pid]) {
                lineItems.nrc.push({ name: priceMap[pid].name, qty: qty, price: priceMap[pid].price });
            }
        });

        // E. LABOR & SURVEY
        let analogCount = parseFloat(getVal("Analog_Line_Count")||0) + parseFloat(getVal("POTS_for_Paging_Qty")||0) + parseFloat(getVal("T_38_Fax")||0);
        if(analogCount > 0 && ID_MAP["SITE_SURVEY"]) {
            let sId = ID_MAP["SITE_SURVEY"];
            if(priceMap[sId]) lineItems.nrc.push({ name: priceMap[sId].name, qty: 1, price: priceMap[sId].price });
        }

        let totalPhones = phoneSubform.reduce((sum, r) => sum + parseFloat(r.Phone_Qty||0), 0);
        if(getVal("On_Site_Install") === "Yes" && totalPhones > 0 && ID_MAP["LABOR"]) {
            let lId = ID_MAP["LABOR"];
            if(priceMap[lId]) {
                let laborUnits = Math.ceil(totalPhones / 5.0);
                lineItems.nrc.push({ name: priceMap[lId].name, qty: laborUnits, price: priceMap[lId].price });
            }
        }

        renderTables();
        showLoader(false);
    }

    function getVal(key) { return dealRecord[key]; }

    // --- RENDER & ACTIONS ---
    function renderTables() {
        
        // SORT MRC: Items with onboarding fees go to the top
        lineItems.mrc.sort((a, b) => {
            return (b.hasOnboarding ? 1 : 0) - (a.hasOnboarding ? 1 : 0);
        });

        let renderRows = (list, bodyId, totalId) => {
            let html = "", totalVal = 0;
            if(list.length === 0) html = "<tr><td colspan='4' style='color:#999; text-align:center;'>No Items</td></tr>";
            list.forEach(item => {
                let lineTotal = item.qty * item.price;
                totalVal += lineTotal;
                let badge = "";
                if(item.isEntitlement) badge = " <span class='badge-included'>Included</span>";
                if(item.isExcess) badge = " <span class='badge-excess'>Excess</span>";
                
                html += `<tr><td>${item.name}${badge}</td><td class="col-qty">${item.qty}</td>
                         <td class="col-money">$${item.price.toFixed(2)}</td><td class="col-money">$${lineTotal.toFixed(2)}</td></tr>`;
            });
            document.getElementById(bodyId).innerHTML = html;
            document.getElementById(totalId).innerText = "$" + totalVal.toFixed(2);
        };
        renderRows(lineItems.mrc, "mrcBody", "totalMrcDisplay");
        renderRows(lineItems.nrc, "nrcBody", "totalNrcDisplay");
    }

    function handleSaveAndFinish() {
        if(!confirm("Proceed with this Quote?")) return;
        showLoader(true, "Generating PDF...");
        let element = document.getElementById('quoteContainer');
        let filename = (dealRecord.Deal_Name || "Quote").replace(/[^a-z0-9]/gi, '_') + " - V1.pdf";
        html2pdf().set({ margin:0.5, filename:filename, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'letter'} })
        .from(element).outputPdf('blob').then(b => uploadToCRM(b, filename));
    }

    function uploadToCRM(blob, filename) {
        document.getElementById("loaderText").innerText = "Uploading PDF...";
        let file = new File([blob], filename, { type: "application/pdf" });
        ZOHO.CRM.API.attachFile({ Entity: "Deals", RecordID: dealId, File: { file_obj: file } })
        .then(() => {
            document.getElementById("loaderText").innerText = "Advancing Blueprint...";
            ZOHO.CRM.BLUEPRINT.proceed({ transition_id: PROCEED_TRANSITION_NAME, data: {} }).then(() => ZOHO.CRM.UI.Popup.closeReload());
        })
        .catch(err => { alert("Error: " + JSON.stringify(err)); showLoader(false); });
    }

    function handleStartOver() {
        if(!confirm("Clear all data and Start Over?")) return;
        showLoader(true, "Clearing Records...");
        let updateMap = {};
        for (let key in dealRecord) {
            if (!key.startsWith("$") && !SAFE_FIELDS.includes(key) && dealRecord[key] !== null) {
                updateMap[key] = null;
            }
        }
        updateMap["Phone_Hardware"] = []; 
        ZOHO.CRM.API.updateRecord({ Entity: "Deals", APIData: { id: dealId, ...updateMap } })
        .then(() => {
            ZOHO.CRM.BLUEPRINT.proceed({ transition_id: RESTART_TRANSITION_NAME, data: {} }).then(() => ZOHO.CRM.UI.Popup.closeReload());
        });
    }

    function showLoader(v, t) { document.getElementById("loader").style.display = v?"block":"none"; if(t)document.getElementById("loaderText").innerText = t; }
</script>
</body>
</html>
