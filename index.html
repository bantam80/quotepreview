<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Quote Preview & Gatekeeper</title>
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f5f7; padding: 20px; color: #333; }
        
        /* LAYOUT CONTAINERS */
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }
        .header h2 { margin: 0; color: #2c3e50; }
        .doc-info { text-align: right; font-size: 14px; color: #777; }

        /* PREVIEW TABLES */
        .section-title { font-size: 16px; font-weight: bold; margin: 20px 0 10px; color: #444; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 14px; }
        th { background: #f8f9fa; color: #555; text-align: left; padding: 10px; border-bottom: 2px solid #ddd; font-weight: 600; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .col-qty { width: 60px; text-align: center; }
        .col-money { width: 100px; text-align: right; }
        .total-row td { font-weight: bold; background-color: #fdfdfd; border-top: 2px solid #ddd; color: #000; }
        
        /* ENTITLEMENT STYLING */
        .badge-included { background: #e6f4ea; color: #1e7e34; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .badge-paid { background: #fff3cd; color: #856404; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }

        /* ACTION BAR */
        .action-bar { margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        
        button { padding: 12px 24px; border: none; border-radius: 5px; font-size: 15px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed; }

        /* BUTTON VARIANTS */
        .btn-restart { background-color: #fff; border: 2px solid #dc3545; color: #dc3545; }
        .btn-restart:hover { background-color: #dc3545; color: white; }

        .btn-save { background-color: #28a745; color: white; display: flex; align-items: center; gap: 8px; }
        .btn-save:hover { background-color: #218838; }

        /* LOADING OVERLAY */
        #loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 999; text-align: center; padding-top: 200px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <h3 id="loaderText">Processing...</h3>
</div>

<div class="container" id="quoteContainer">
    
    <div class="header">
        <h2>Quote Preview</h2>
        <div class="doc-info">
            <div id="dealNameDisplay">Deal Name</div>
            <div id="dateDisplay">Date: --/--/----</div>
        </div>
    </div>

    <div class="section-title">Monthly Recurring Charges (MRC)</div>
    <table id="mrcTable">
        <thead>
            <tr>
                <th>Item</th>
                <th class="col-qty">Qty</th>
                <th class="col-money">Rate</th>
                <th class="col-money">Total</th>
            </tr>
        </thead>
        <tbody id="mrcBody"></tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="3" style="text-align:right;">TOTAL MONTHLY:</td>
                <td class="col-money" id="totalMrcDisplay">$0.00</td>
            </tr>
        </tfoot>
    </table>

    <div class="section-title" style="margin-top: 30px;">One-Time Charges (NRC)</div>
    <table id="nrcTable">
        <thead>
            <tr>
                <th>Item</th>
                <th class="col-qty">Qty</th>
                <th class="col-money">Rate</th>
                <th class="col-money">Total</th>
            </tr>
        </thead>
        <tbody id="nrcBody"></tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="3" style="text-align:right;">TOTAL ONE-TIME:</td>
                <td class="col-money" id="totalNrcDisplay">$0.00</td>
            </tr>
        </tfoot>
    </table>

</div>

<div class="container" style="margin-top: 15px; background: transparent; box-shadow: none; padding: 0;">
    <div class="action-bar">
        <button class="btn-restart" onclick="handleStartOver()">&#8634; Start Over</button>
        
        <button class="btn-save" id="btnSave" onclick="handleSaveAndFinish()">
            <span>Save PDF & Finish</span> 
            <span>&#10140;</span>
        </button>
    </div>
</div>

<script>
    /* =================================================================
       CONFIGURATION
       ================================================================= */
    
    // !!! IMPORTANT: CHANGE THIS TO MATCH YOUR BLUEPRINT BUTTON NAME !!!
    // The button that moves the deal BACK to Qualification
    const Solution_Design = "Restart"; 
    
    // The button that moves the deal FORWARD (Proceed)
    const PROCEED_TRANSITION_NAME = "Proceed"; 

    // FIELDS TO KEEP SAFE DURING WIPE (From WipeRecord.txt)
    const SAFE_FIELDS = [
        "Form_Update_Key", "VoiceOS_Other", "Questionnaire_Link", "Opp_Created_Time",
        "Deal_Name", "Pipeline", "Stage", "Closing_Date", "Account_Name", "Owner", 
        "Probability", "End_Customer", "Next_Step", "id", "Created_Time", 
        "Modified_Time", "Created_By", "Modified_By", "Tag", "Layout", "Wizard_Dependency"
    ];

    // PRICING ID MAP (From CreateQuoteCodeR2.txt)
    const ID_MAP = {
        "VMTRANS": "1231536000013241029", "ENHCLID": "1231536000013499025", "E911": "1231536000013499026",
        "SIP_TRUNK": "1231536000013499027", "SIP_PRI": "1231536000013241014", "SIP_BACK": "1231536000013499028",
        "UC_STD": "1231536000009612019", "UC_ADV": "1231536000009612022", "UC_CC": "1231536000009612025",
        "POTS": "1231536000013241011", "WEBFAX": "1231536000013241043", "T38": "1231536000013241017",
        "TEAMS_SIP": "1231536000013241023", "TEAMS_PBX": "1231536000013241020", "FAX_EMAIL": "1231536000013241026",
        "ONB_ADV": "1231536000009612029", "ONB_STD": "1231536000009612028", "ONB_CC": "1231536000009612030",
        "ONB_POTS": "1231536000013241066", "SITE_SURVEY": "1231536000013499030", "LABOR": "1231536000013235207",
        "DID_LOCAL": "1231536000013261029", "DID_TF": "1231536000013261030",
        "LNP_LOCAL": "1231536000013261027", "LNP_TF": "1231536000013261028"
    };

    // ENTITLEMENT CONFIG
    const ENTITLEMENT_ORDER = [
        { field: "New_DID", key: "DID_LOCAL", name: "New Local DID" },
        { field: "Porting_DID", key: "LNP_LOCAL", name: "Porting Local DID" },
        { field: "New_TFN", key: "DID_TF", name: "New Toll-Free" },
        { field: "Porting_TFN", key: "LNP_TF", name: "Porting Toll-Free" }
    ];
    const EXCESS_MRC_RATE = 1.00;
    const EXCESS_NRC_RATE = 2.00;

    /* =================================================================
       STATE MANAGEMENT
       ================================================================= */
    let dealId = null;
    let dealRecord = {};
    let lineItems = { mrc: [], nrc: [] };
    let totalMRC = 0.0;
    let totalNRC = 0.0;

    ZOHO.embeddedApp.on("PageLoad", function(data){
        if(data && data.EntityId) {
            dealId = Array.isArray(data.EntityId) ? data.EntityId[0] : data.EntityId;
            initWidget();
        }
    });

    ZOHO.embeddedApp.init();

    function initWidget() {
        document.getElementById("dateDisplay").innerText = "Date: " + new Date().toLocaleDateString();
        showLoader(true, "Loading Deal Data...");

        ZOHO.CRM.API.getRecord({ Entity: "Deals", RecordID: dealId })
        .then(function(response){
            if(response.data) {
                dealRecord = response.data[0];
                document.getElementById("dealNameDisplay").innerText = dealRecord.Deal_Name;
                calculateQuote();
            }
        });
    }

    /* =================================================================
       CALCULATION LOGIC (Ported from Deluge)
       ================================================================= */
    async function calculateQuote() {
        lineItems.mrc = [];
        lineItems.nrc = [];
        
        // 1. GATHER PRODUCT IDs TO FETCH
        let productsToFetch = new Set();
        
        // Helper to queue fetch
        const queueFetch = (key) => { if(ID_MAP[key]) productsToFetch.add(ID_MAP[key]); };

        // Check MRC/Setup Fields
        if(getVal("Voicemail_Transcription") === "Yes") queueFetch("VMTRANS");
        if(getVal("Enhanced_Caller_ID") === "Yes") queueFetch("ENHCLID");
        if(getVal("SIP_Trunks_Qty") > 0) queueFetch("SIP_TRUNK");
        if(getVal("Standard_Qty") > 0) { queueFetch("UC_STD"); queueFetch("ONB_STD"); }
        if(getVal("Advanced_Qty") > 0) { queueFetch("UC_ADV"); queueFetch("ONB_ADV"); }
        
        // Check Entitlements
        ENTITLEMENT_ORDER.forEach(e => {
            if(getVal(e.field) > 0) queueFetch(e.key);
        });

        // Check Hardware Subform
        let phoneSubform = dealRecord.Phone_Hardware || [];
        phoneSubform.forEach(row => {
            if(row.Phone_Selection) productsToFetch.add(row.Phone_Selection.id);
        });

        // Check Labor/Survey
        queueFetch("SITE_SURVEY");
        queueFetch("LABOR");

        // 2. FETCH PRICING (Batch)
        // Since JS SDK doesn't have "getRecordsByIds", we must use search or multiple calls.
        // For performance in widget, we will assume standard list prices or 
        // fetch individually if list is small. Here we implement a parallel fetch.
        let priceMap = {};
        let fetchPromises = Array.from(productsToFetch).map(id => 
            ZOHO.CRM.API.getRecord({ Entity: "Products", RecordID: id })
            .then(r => {
                if(r.data && r.data[0]) {
                    priceMap[id] = { 
                        name: r.data[0].Product_Name, 
                        price: r.data[0].Unit_Price || 0 
                    };
                }
            })
            .catch(e => console.log("Prod fetch fail", id))
        );

        await Promise.all(fetchPromises);

        // 3. BUILD LINE ITEMS

        // --- A. MRC ITEMS ---
        addMrcLine("Voicemail Transcription", "VMTRANS", (getVal("Voicemail_Transcription")=="Yes"?1:0), priceMap);
        addMrcLine("Standard User", "UC_STD", getVal("Standard_Qty"), priceMap);
        addMrcLine("Advanced User", "UC_ADV", getVal("Advanced_Qty"), priceMap);
        addMrcLine("SIP Trunks", "SIP_TRUNK", getVal("SIP_Trunks_Qty"), priceMap);
        // ... (Add other mappings from your config as needed)

        // --- B. ENTITLEMENTS ---
        let remEnt = parseFloat(getVal("TN_Entitlements") || 0);
        
        ENTITLEMENT_ORDER.forEach(item => {
            let qty = parseFloat(getVal(item.field) || 0);
            let prodId = ID_MAP[item.key];
            if(qty > 0 && prodId && priceMap[prodId]) {
                let freeQty = 0;
                let paidQty = 0;

                if(qty <= remEnt) {
                    freeQty = qty;
                    remEnt -= qty;
                } else {
                    freeQty = remEnt;
                    paidQty = qty - remEnt;
                    remEnt = 0;
                }

                let pName = priceMap[prodId].name;

                if(freeQty > 0) {
                    lineItems.mrc.push({ name: pName, qty: freeQty, price: 0, isEntitlement: true });
                }
                if(paidQty > 0) {
                    // Paid Entitlements have special pricing (MRC=1, NRC=2)
                    lineItems.mrc.push({ name: pName + " (Excess)", qty: paidQty, price: EXCESS_MRC_RATE });
                    lineItems.nrc.push({ name: pName + " (Excess Setup)", qty: paidQty, price: EXCESS_NRC_RATE });
                }
            }
        });

        // --- C. HARDWARE (NRC) ---
        phoneSubform.forEach(row => {
            let pid = row.Phone_Selection ? row.Phone_Selection.id : null;
            let qty = parseFloat(row.Phone_Qty || 0);
            if(pid && qty > 0 && priceMap[pid]) {
                lineItems.nrc.push({ 
                    name: priceMap[pid].name, 
                    qty: qty, 
                    price: priceMap[pid].price 
                });
            }
        });

        // --- D. LABOR & SURVEY ---
        let analogCount = parseFloat(getVal("Analog_Line_Count")||0) + parseFloat(getVal("POTS_for_Paging_Qty")||0);
        if(analogCount > 0) {
            addNrcLine("Site Survey", "SITE_SURVEY", 1, priceMap);
        }

        let totalPhones = phoneSubform.reduce((sum, r) => sum + parseFloat(r.Phone_Qty||0), 0);
        if(getVal("On_Site_Install") === "Yes" && totalPhones > 0) {
            let laborUnits = Math.ceil(totalPhones / 5.0);
            addNrcLine("On-Site Labor (Units of 5)", "LABOR", laborUnits, priceMap);
        }

        renderTables();
        showLoader(false);
    }

    function getVal(apiName) {
        return dealRecord[apiName];
    }

    function addMrcLine(label, mapKey, qty, priceMap) {
        qty = parseFloat(qty || 0);
        let pid = ID_MAP[mapKey];
        if(qty > 0 && pid && priceMap[pid]) {
            lineItems.mrc.push({ name: priceMap[pid].name, qty: qty, price: priceMap[pid].price });
        }
    }

    function addNrcLine(label, mapKey, qty, priceMap) {
        qty = parseFloat(qty || 0);
        let pid = ID_MAP[mapKey];
        if(qty > 0 && pid && priceMap[pid]) {
            lineItems.nrc.push({ name: priceMap[pid].name, qty: qty, price: priceMap[pid].price });
        }
    }

    /* =================================================================
       RENDER UI
       ================================================================= */
    function renderTables() {
        // Render MRC
        let mrcHtml = "";
        totalMRC = 0;
        if(lineItems.mrc.length === 0) mrcHtml = "<tr><td colspan='4' style='color:#999; text-align:center;'>No Recurring Items</td></tr>";
        
        lineItems.mrc.forEach(item => {
            let total = item.qty * item.price;
            totalMRC += total;
            let badge = "";
            if(item.isEntitlement) badge = " <span class='badge-included'>Included</span>";
            else if(item.price === 1.00) badge = " <span class='badge-paid'>Excess</span>";

            mrcHtml += `<tr>
                <td>${item.name}${badge}</td>
                <td class="col-qty">${item.qty}</td>
                <td class="col-money">$${item.price.toFixed(2)}</td>
                <td class="col-money">$${total.toFixed(2)}</td>
            </tr>`;
        });
        document.getElementById("mrcBody").innerHTML = mrcHtml;
        document.getElementById("totalMrcDisplay").innerText = "$" + totalMRC.toFixed(2);

        // Render NRC
        let nrcHtml = "";
        totalNRC = 0;
        if(lineItems.nrc.length === 0) nrcHtml = "<tr><td colspan='4' style='color:#999; text-align:center;'>No One-Time Items</td></tr>";

        lineItems.nrc.forEach(item => {
            let total = item.qty * item.price;
            totalNRC += total;
            nrcHtml += `<tr>
                <td>${item.name}</td>
                <td class="col-qty">${item.qty}</td>
                <td class="col-money">$${item.price.toFixed(2)}</td>
                <td class="col-money">$${total.toFixed(2)}</td>
            </tr>`;
        });
        document.getElementById("nrcBody").innerHTML = nrcHtml;
        document.getElementById("totalNrcDisplay").innerText = "$" + totalNRC.toFixed(2);
    }

    /* =================================================================
       ACTION: SAVE PDF & FINISH
       ================================================================= */
    function handleSaveAndFinish() {
        if(!confirm("This will save the PDF to the Deal and advance the Blueprint. Proceed?")) return;

        showLoader(true, "Generating PDF...");
        
        let element = document.getElementById('quoteContainer');
        let filename = (dealRecord.Deal_Name || "Quote").replace(/[^a-z0-9]/gi, '_') + " - V1.pdf";

        let opt = {
            margin:       0.5,
            filename:     filename,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        // Generate Blob
        html2pdf().set(opt).from(element).outputPdf('blob').then(function(pdfBlob) {
            uploadToCRM(pdfBlob, filename);
        });
    }

    function uploadToCRM(blob, filename) {
        document.getElementById("loaderText").innerText = "Uploading PDF...";
        
        // Convert Blob to File object for Zoho SDK
        let file = new File([blob], filename, { type: "application/pdf" });

        ZOHO.CRM.API.attachFile({ Entity: "Deals", RecordID: dealId, File: { file_obj: file } })
        .then(function(data){
            console.log("Upload Success", data);
            document.getElementById("loaderText").innerText = "Advancing Blueprint...";
            
            // ADVANCE BLUEPRINT
            ZOHO.CRM.BLUEPRINT.proceed({
                transition_id: PROCEED_TRANSITION_NAME, // Note: SDK might expect ID or Name depending on version, Name usually works if unique
                data: {}
            }).then(function(){
                ZOHO.CRM.UI.Popup.closeReload();
            });
        })
        .catch(function(err){
            alert("Error uploading file: " + JSON.stringify(err));
            showLoader(false);
        });
    }

    /* =================================================================
       ACTION: START OVER (WIPE)
       ================================================================= */
    function handleStartOver() {
        if(!confirm("Are you sure you want to START OVER?\n\nThis will clear all quote data from this Deal and move the stage back.")) return;

        showLoader(true, "Clearing Records...");

        let updateMap = {};
        
        // Identify fields to nullify
        for (let key in dealRecord) {
            // Ignore System Fields and Safe Fields
            if (!key.startsWith("$") && !SAFE_FIELDS.includes(key)) {
                // Determine if it is a list/subform or simple field
                if(Array.isArray(dealRecord[key])) {
                    // For subforms, we can't send null, usually sending empty list works or API specific
                    // Simplest is to ignore or send empty array if API supports
                } else if (dealRecord[key] !== null) {
                    updateMap[key] = null;
                }
            }
        }

        // Specific handling for subform 'Phone_Hardware' - usually requires deleting rows
        // Note: 'null' on a subform key often clears it in Zoho API v2.1
        updateMap["Phone_Hardware"] = [];

        ZOHO.CRM.API.updateRecord({ Entity: "Deals", APIData: { id: dealId, ...updateMap } })
        .then(function(data){
            document.getElementById("loaderText").innerText = "Returning to Qualification...";
            
            // TRIGGER BACK TRANSITION
            ZOHO.CRM.BLUEPRINT.proceed({
                transition_id: RESTART_TRANSITION_NAME,
                data: {}
            }).then(function(){
                ZOHO.CRM.UI.Popup.closeReload();
            });
        })
        .catch(function(err){
            alert("Error clearing record: " + JSON.stringify(err));
            showLoader(false);
        });
    }

    function showLoader(visible, text) {
        document.getElementById("loader").style.display = visible ? "block" : "none";
        if(text) document.getElementById("loaderText").innerText = text;
    }

</script>

</body>
</html>
