<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Quote Preview & Gatekeeper</title>
    
    <script>
        window.setImmediate = window.setImmediate || function(fn) { return window.setTimeout(fn, 0); };
        window.clearImmediate = window.clearImmediate || function(id) { window.clearTimeout(id); };
    </script>

    <script src="https://live.zwidgets.com/js-sdk/1.1/ZohoEmbededAppSDK.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f5f7; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }
        .header h2 { margin: 0; color: #2c3e50; }
        
        .doc-info { text-align: right; font-size: 14px; color: #777; }
        .quote-ref { font-weight: bold; color: #444; margin-bottom: 4px; font-size: 15px; }

        .section-title { font-size: 16px; font-weight: bold; margin: 20px 0 10px; color: #444; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 14px; }
        th { background: #f8f9fa; color: #555; text-align: left; padding: 10px; border-bottom: 2px solid #ddd; font-weight: 600; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .col-qty { width: 60px; text-align: center; }
        .col-money { width: 100px; text-align: right; }
        .total-row td { font-weight: bold; background-color: #fdfdfd; border-top: 2px solid #ddd; color: #000; }
        
        .badge-included { background: #e6f4ea; color: #1e7e34; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-excess { background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        
        .action-bar { margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        button { padding: 12px 24px; border: none; border-radius: 5px; font-size: 15px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        
        .btn-restart { background-color: #fff; border: 2px solid #dc3545; color: #dc3545; }
        .btn-restart:hover { background-color: #dc3545; color: white; }
        
        .btn-save { background-color: #28a745; color: white; display: flex; align-items: center; gap: 8px; }
        .btn-save:hover { background-color: #218838; }
        
        /* OVERLAY LOADER */
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; text-align: center; padding-top: 250px; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; display: inline-block; margin-bottom: 15px; }
        #loaderText { font-size: 18px; color: #333; font-weight: 600; }
        #loaderSubText { font-size: 14px; color: #666; margin-top: 10px; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .version-footer { text-align: center; margin-top: 20px; font-size: 12px; color: #999; opacity: 0.6; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <div id="loaderText">Processing...</div>
    <div id="loaderSubText">Please wait. Verifying update...</div>
</div>

<div class="container" id="quoteContainer">
    <div class="header">
        <h2>Quote Preview</h2>
        <div class="doc-info">
            <div id="dealNameDisplay">Deal Name</div>
            <div id="quoteIdDisplay" class="quote-ref">Quote: --</div>
            <div id="dateDisplay">Date: --/--/----</div>
        </div>
    </div>
    <div class="section-title">Monthly Recurring Charges (MRC)</div>
    <table id="mrcTable">
        <thead><tr><th>Item</th><th class="col-qty">Qty</th><th class="col-money">Rate</th><th class="col-money">Total</th></tr></thead>
        <tbody id="mrcBody"></tbody>
        <tfoot><tr class="total-row"><td colspan="3" style="text-align:right;">TOTAL MONTHLY:</td><td class="col-money" id="totalMrcDisplay">$0.00</td></tr></tfoot>
    </table>
    <div class="section-title" style="margin-top: 30px;">One-Time Charges (NRC)</div>
    <table id="nrcTable">
        <thead><tr><th>Item</th><th class="col-qty">Qty</th><th class="col-money">Rate</th><th class="col-money">Total</th></tr></thead>
        <tbody id="nrcBody"></tbody>
        <tfoot><tr class="total-row"><td colspan="3" style="text-align:right;">TOTAL ONE-TIME:</td><td class="col-money" id="totalNrcDisplay">$0.00</td></tr></tfoot>
    </table>
</div>

<div class="container" style="margin-top: 15px; background: transparent; box-shadow: none; padding: 0;">
    <div class="action-bar">
        <button class="btn-restart" onclick="handleStartOver()">&#8634; Start Over</button>
        <button class="btn-save" id="btnSave" onclick="handleSaveAndFinish()"><span>Download PDF & Finish</span> <span>&#10140;</span></button>
    </div>
    <div class="version-footer">Widget Version: V55 (Trust But Verify)</div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const PROCEED_TRANSITION_ID = "Proceed"; 

    // MAPPINGS
    const ID_MAP = {
        "DID_LOCAL": "1231536000013261029", "DID_TF": "1231536000013261030",
        "LNP_LOCAL": "1231536000013261027", "LNP_TF": "1231536000013261028",
        "TF_BUNDLE": "1231536000013499029",
        "VMTRANS": "1231536000013241029", "ENHCLID": "1231536000013499025", "E911": "1231536000013499026",
        "SIP_TRUNK": "1231536000013499027", "SIP_PRI": "1231536000013241014", "SIP_BACK": "1231536000013499028",
        "UC_STD": "1231536000009612019", "UC_ADV": "1231536000009612022", "UC_CC": "1231536000009612025",
        "POTS": "1231536000013241011", "WEBFAX": "1231536000013241043", "T38": "1231536000013241017",
        "TEAMS_SIP": "1231536000013241023", "TEAMS_PBX": "1231536000013241020", "FAX_EMAIL": "1231536000013241026",
        "ONB_ADV": "1231536000009612029", "ONB_STD": "1231536000009612028", "ONB_CC": "1231536000009612030",
        "ONB_POTS": "1231536000013241066", "SITE_SURVEY": "1231536000013499030", "LABOR": "1231536000013235207"
    };

    const SAFE_FIELDS = [
        "Contact_Name", "VoiceOS_Other", "Form_Update_Key", "Questionnaire_Link", 
        "Opp_Created_Time", "Deal_Name", "Pipeline", "Stage", "Closing_Date", 
        "Account_Name", "Owner", "Probability", "End_Customer", "Next_Step", 
        "id", "Created_Time", "Modified_Time", "Created_By", "Modified_By", 
        "Tag", "Layout", "Wizard_Dependency", "Survey_Required", 
        "Quote_JSON_Payload", "QuoteGen"
    ];

    const MRC_CONFIG = { "Voicemail_Transcription": "VMTRANS", "Enhanced_Caller_ID": "ENHCLID", "SIP_Trunks_Qty": "SIP_TRUNK", "TTL_SIP_Trunks_Primary": "SIP_PRI", "TTL_SIP_Trunks_Backup": "SIP_BACK", "Standard_Qty": "UC_STD", "Advanced_Qty": "UC_ADV", "Contact_Center_Qty": "UC_CC", "POTS_for_Paging_Qty": "POTS", "Webfax": "WEBFAX", "T_38_Fax": "T38", "MS_Teams_SIP": "TEAMS_SIP", "MS_Teams_PBX": "TEAMS_PBX", "Fax_to_Email": "FAX_EMAIL", "Analog_Line_Count": "POTS" };
    const SETUP_CONFIG = { "Advanced_Qty": "ONB_ADV", "Standard_Qty": "ONB_STD", "Contact_Center_Qty": "ONB_CC", "Analog_Line_Count": "ONB_POTS", "POTS_for_Paging_Qty": "ONB_POTS", "Webfax": "ONB_ADV", "T_38_Fax": "ONB_POTS", "MS_Teams_SIP": "ONB_ADV", "MS_Teams_PBX": "ONB_ADV", "Fax_to_Email": "ONB_STD" };
    const ENTITLEMENT_LIST = [ { field: "New_DID_Qty", key: "DID_LOCAL" }, { field: "Porting_DID_Qty", key: "LNP_LOCAL" }, { field: "New_TFN_Qty", key: "DID_TF" }, { field: "Porting_TFN_Qty", key: "LNP_TF" } ];
    const EXCESS_MRC_RATE = 1.00;
    const EXCESS_NRC_RATE = 2.00;

    var dealId = null;
    var dealRecord = null;
    var lineItems = { mrc: [], nrc: [] };

    ZOHO.embeddedApp.on("PageLoad", function(data){
        if(data && data.EntityId) {
            dealId = Array.isArray(data.EntityId) ? data.EntityId[0] : data.EntityId;
            initWidget();
        }
    });

    ZOHO.embeddedApp.init().then(function(){ console.log("Zoho SDK Initialized"); });

    function initWidget() {
        if(dealId) {
            let shortId = String(dealId).slice(-4);
            document.getElementById("quoteIdDisplay").innerText = "Quote: " + shortId + Date.now();
        }
        document.getElementById("dateDisplay").innerText = "Date: " + new Date().toLocaleDateString();
        showLoader(true, "Loading Deal Data...");
        
        ZOHO.CRM.API.getRecord({ Entity: "Deals", RecordID: dealId }).then(function(response){
            if(response.data) {
                dealRecord = response.data[0];
                document.getElementById("dealNameDisplay").innerText = dealRecord.Deal_Name;
                calculateQuote();
            }
        });
    }

    async function calculateQuote() {
        // [Logic unchanged for brevity]
        lineItems = { mrc: [], nrc: [] };
        let productsToFetch = new Set();
        const queue = (key) => { if(ID_MAP[key]) productsToFetch.add(ID_MAP[key]); };

        for(let f in MRC_CONFIG) { if(getVal(f)>0 || getVal(f)==="Yes") queue(MRC_CONFIG[f]); }
        for(let f in SETUP_CONFIG) { if(getVal(f)>0) queue(SETUP_CONFIG[f]); }
        if(getVal("E911_Locations")>0) queue("E911");
        ENTITLEMENT_LIST.forEach(e => { if(getVal(e.field)>0) queue(e.key); });
        if(getVal("Est_Toll_Free_Minutes")>0) queue("TF_BUNDLE");
        let phoneSubform = dealRecord.Phone_Hardware||[];
        phoneSubform.forEach(row => { if(row.Phone_Selection) productsToFetch.add(row.Phone_Selection.id); });
        queue("SITE_SURVEY"); queue("LABOR");

        let priceMap = {};
        let fetchPromises = Array.from(productsToFetch).map(id => 
            ZOHO.CRM.API.getRecord({ Entity: "Products", RecordID: id }).then(r => {
                if(r.data && r.data[0]) priceMap[id] = { name: r.data[0].Product_Name, price: r.data[0].Unit_Price||0, sku: r.data[0].Product_Code||"" };
            }).catch(e => console.error(e))
        );
        await Promise.all(fetchPromises);

        for(let f in MRC_CONFIG) {
            let v = getVal(f); let q = (v==="Yes"||v===true)?1:parseFloat(v||0);
            if(q>0 && ID_MAP[MRC_CONFIG[f]] && priceMap[ID_MAP[MRC_CONFIG[f]]]) {
                let p = priceMap[ID_MAP[MRC_CONFIG[f]]];
                lineItems.mrc.push({name:p.name, qty:q, price:p.price, sku:p.sku, hasOnboarding:true});
            }
        }
        for(let f in SETUP_CONFIG) {
            let q = parseFloat(getVal(f)||0);
            if(q>0 && ID_MAP[SETUP_CONFIG[f]] && priceMap[ID_MAP[SETUP_CONFIG[f]]]) {
                let p = priceMap[ID_MAP[SETUP_CONFIG[f]]];
                lineItems.nrc.push({name:p.name+" (Setup)", qty:q, price:p.price, sku:p.sku});
            }
        }
        let e911 = parseFloat(getVal("E911_Locations")||0);
        if(e911>0 && priceMap[ID_MAP["E911"]]) {
            let p=priceMap[ID_MAP["E911"]];
            lineItems.mrc.push({name:p.name, qty:1, price:0, sku:p.sku, isEntitlement:true});
            if(e911>1) lineItems.mrc.push({name:p.name, qty:e911-1, price:p.price, sku:p.sku});
        }
        let remEnt = parseFloat(getVal("TN_Entitlements")||0);
        ENTITLEMENT_LIST.forEach(item => {
            let qty = parseFloat(getVal(item.field)||0);
            let prodId = ID_MAP[item.key];
            if(qty>0 && prodId && priceMap[prodId]) {
                let freeQty=0, paidQty=0;
                if(qty<=remEnt) { freeQty=qty; remEnt-=qty; } else { freeQty=remEnt; paidQty=qty-remEnt; remEnt=0; }
                let p = priceMap[prodId];
                if(freeQty>0) { lineItems.mrc.push({name:p.name,qty:freeQty,price:0,sku:p.sku,isEntitlement:true}); lineItems.nrc.push({name:p.name,qty:freeQty,price:0,sku:p.sku,isEntitlement:true}); }
                if(paidQty>0) { lineItems.mrc.push({name:p.name,qty:paidQty,price:EXCESS_MRC_RATE,sku:p.sku,isExcess:true}); lineItems.nrc.push({name:p.name,qty:paidQty,price:EXCESS_NRC_RATE,sku:p.sku,isExcess:true}); }
            }
        });
        let tfMinutes = parseFloat(getVal("Est_Toll_Free_Minutes")||0);
        if(tfMinutes>0 && ID_MAP["TF_BUNDLE"] && priceMap[ID_MAP["TF_BUNDLE"]]) {
            let qty = Math.ceil(tfMinutes/500); let p = priceMap[ID_MAP["TF_BUNDLE"]];
            lineItems.mrc.push({ name: p.name+` (${tfMinutes} min)`, qty: qty, price: p.price, sku: p.sku });
        }
        phoneSubform.forEach(r => {
            let pid = r.Phone_Selection?r.Phone_Selection.id:null; let q=parseFloat(r.Phone_Qty||0);
            if(pid && q>0 && priceMap[pid]) lineItems.nrc.push({name:priceMap[pid].name, qty:q, price:priceMap[pid].price, sku:priceMap[pid].sku});
        });
        let survey = getVal("Survey_Required"); let paging = parseFloat(getVal("POTS_for_Paging_Qty")||0);
        if((paging>0 || (survey && String(survey).toLowerCase()==="yes")) && priceMap[ID_MAP["SITE_SURVEY"]]) {
            let p=priceMap[ID_MAP["SITE_SURVEY"]]; lineItems.nrc.push({name:p.name, qty:1, price:p.price, sku:p.sku});
        }
        let totPhones = phoneSubform.reduce((s,r)=>s+parseFloat(r.Phone_Qty||0),0);
        if(getVal("On_Site_Install")==="Yes" && totPhones>0 && priceMap[ID_MAP["LABOR"]]) {
            let p=priceMap[ID_MAP["LABOR"]]; let u=Math.ceil(totPhones/5.0);
            lineItems.nrc.push({name:p.name, qty:u, price:p.price, sku:p.sku});
        }

        renderTables();
        showLoader(false);
    }

    function getVal(key) { return dealRecord[key]; }

    function renderTables() {
        let fill = (list, body, tot) => {
            let h="", t=0;
            list.forEach(i => {
                let lt = i.qty*i.price; t+=lt;
                h += `<tr><td>${i.name}${i.isEntitlement?" <span class='badge-included'>Included</span>":""}</td><td class="col-qty">${i.qty}</td><td class="col-money">$${i.price.toFixed(2)}</td><td class="col-money">$${lt.toFixed(2)}</td></tr>`;
            });
            document.getElementById(body).innerHTML = h; document.getElementById(tot).innerText = "$"+t.toFixed(2);
        };
        fill(lineItems.mrc, "mrcBody", "totalMrcDisplay");
        fill(lineItems.nrc, "nrcBody", "totalNrcDisplay");
    }

    // --- 6. ACTION: MAIN EXECUTION FLOW ---
    async function handleSaveAndFinish() {
        if(!dealRecord) { alert("Data not loaded"); return; }
        if(!confirm("Are you sure? This will Generate the Quote and Advance the Deal.")) return;
        
        // STEP 1: Lock UI with Overlay
        showLoader(true, "Initializing...");

        try {
            // STEP 2: Generate PDF (Wait for download trigger)
            updateLoader("Generating PDF...");
            await generatePDF();

            // STEP 3: Save JSON Payload
            updateLoader("Saving Quote Data...");
            await savePayloadToCRM();

            // STEP 4: Attempt Blueprint & VERIFY
            updateLoader("Advancing Blueprint (Verifying)...");
            
            // We use a custom function to handle the 400 Error gracefully
            let success = await attemptBlueprintWithVerification();

            if(success) {
                updateLoader("Success! Refreshing...");
                setTimeout(function(){
                    // Navigate to same record to force full reload
                    ZOHO.CRM.UI.Record.open({ Entity: "Deals", RecordID: dealId })
                    .then(() => ZOHO.CRM.UI.Popup.close());
                }, 1500);
            } else {
                // FAILURE PATH: KEEP WIDGET OPEN
                showLoader(false); // Hide overlay so user can read alert
                alert("Quote Saved Successfully!\n\nHowever, the Blueprint requires manual input (e.g. FOC Date).\n\nPlease close this window and click the 'Proceed' button manually.");
            }

        } catch (error) {
            console.error(error);
            showLoader(false);
            alert("Process Interrupted:\n" + error.message);
        }
    }

    function generatePDF() {
        return new Promise(async (resolve, reject) => {
            try {
                const { jsPDF } = window.jspdf;
                let element = document.getElementById('quoteContainer');
                let canvas = await html2canvas(element, { scale: 2 });
                let imgData = canvas.toDataURL('image/jpeg', 0.98);
                let pdf = new jsPDF({ orientation: 'p', unit: 'in', format: 'letter' });
                let imgProps = pdf.getImageProperties(imgData);
                let pdfWidth = 8.5 - 1.0; 
                let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'JPEG', 0.5, 0.5, pdfWidth, pdfHeight);
                let filename = "Quote_" + (dealRecord.Deal_Name || "Deal").replace(/[^a-z0-9]/gi, '_') + ".pdf";
                pdf.save(filename);
                resolve(true);
            } catch(e) { reject(new Error("PDF Generation Failed: " + e.message)); }
        });
    }

    function savePayloadToCRM() {
        return new Promise((resolve, reject) => {
            let acctId = (dealRecord.Account_Name) ? dealRecord.Account_Name.id : null;
            let endCustId = (dealRecord.End_Customer) ? dealRecord.End_Customer.id : null;
            let payloadData = {
                "quote_ref": document.getElementById("quoteIdDisplay").innerText,
                "generated_at": new Date().toISOString(),
                "crm_account_id": acctId, "crm_end_customer_id": endCustId, "crm_opportunity_id": dealId, "items": []
            };
            const pushItem = (item, type) => {
                payloadData.items.push({
                    "sku": item.sku || "NO-SKU", "name": item.name, "qty": item.qty,
                    "rate": item.price, "type": type, "is_entitlement": !!item.isEntitlement
                });
            };
            lineItems.mrc.forEach(i => pushItem(i, "MRC"));
            lineItems.nrc.forEach(i => pushItem(i, "NRC"));

            ZOHO.CRM.API.updateRecord({ 
                Entity: "Deals", 
                APIData: { "id": dealId, "Quote_JSON_Payload": JSON.stringify(payloadData), "QuoteGen": true } 
            })
            .then(data => resolve(data))
            .catch(err => reject(new Error("CRM Save Failed: " + JSON.stringify(err))));
        });
    }

    function attemptBlueprintWithVerification() {
        return new Promise((resolve, reject) => {
            let transitionData = {};
            if(dealRecord.Next_Step) transitionData.Next_Step = dealRecord.Next_Step;
            if(dealRecord.End_Customer) transitionData.End_Customer = dealRecord.End_Customer.id;
            if(dealRecord.Account_Name) transitionData.Account_Name = dealRecord.Account_Name.id;
            if(dealRecord.Deal_Name) transitionData.Deal_Name = dealRecord.Deal_Name;
            if(dealRecord.Pipeline) transitionData.Pipeline = dealRecord.Pipeline;

            // 1. Send Command
            ZOHO.CRM.BLUEPRINT.proceed({ transition_id: PROCEED_TRANSITION_ID, data: transitionData })
            .then(() => {
                // 2. WAIT 3 SECONDS (Wait for server 400 or 200)
                console.log("Command sent. Verifying...");
                setTimeout(() => {
                    verifyStageChange(resolve); 
                }, 3000);
            })
            .catch(err => {
                console.error("SDK Reported Error immediately", err);
                resolve(false); // Return false = Manual Handoff
            });
        });
    }

    function verifyStageChange(resolve) {
        // 3. RE-FETCH RECORD to see if it actually moved
        ZOHO.CRM.API.getRecord({ Entity: "Deals", RecordID: dealId })
        .then(function(response) {
            if(response.data && response.data[0]) {
                let newStage = response.data[0].Stage;
                let oldStage = dealRecord.Stage;
                
                console.log("Verification: Old=" + oldStage + ", New=" + newStage);

                if(newStage !== oldStage) {
                    resolve(true); // SUCCESS: It moved!
                } else {
                    resolve(false); // FAIL: It is still in the same stage (400 Error occurred)
                }
            } else {
                resolve(false); // API Fail
            }
        });
    }

    function handleStartOver() {
        if(!dealRecord) return;
        if(!confirm("Clear all data and Start Over?")) return;
        showLoader(true, "Clearing...");
        let updateMap = {};
        for (let key in dealRecord) {
            if (!key.startsWith("$") && !SAFE_FIELDS.includes(key) && dealRecord[key] !== null) { 
                updateMap[key] = null;
            }
        }
        updateMap["Phone_Hardware"] = [];
        updateMap["VoiceOS_Other"] = true;
        ZOHO.CRM.API.updateRecord({ Entity: "Deals", APIData: { id: dealId, ...updateMap } })
        .then(() => {
            ZOHO.CRM.UI.Record.open({ Entity: "Deals", RecordID: dealId }).then(() => ZOHO.CRM.UI.Popup.close());
        })
        .catch(err => {
             console.error("Update Error:", err);
             alert("Error Clearing Records: " + JSON.stringify(err));
             showLoader(false);
        });
    }

    function showLoader(v, t) { 
        document.getElementById("loader").style.display = v?"block":"none";
        if(t) updateLoader(t);
    }
    function updateLoader(t) {
        document.getElementById("loaderText").innerText = t;
    }
</script>
</body>
</html>
