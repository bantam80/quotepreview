<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: monospace; padding: 20px; background: #222; color: #0f0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #444; color: #fff; border: 1px solid #666; }
        button:hover { background: #666; }
        #log { margin-top: 20px; white-space: pre-wrap; border-top: 1px solid #444; padding-top: 10px; }
        .success { color: #0f0; }
        .error { color: #f55; }
        .info { color: #ccf; }
    </style>
    <script src="https://live.zwidgets.com/js-sdk/1.1/ZohoEmbededAppSDK.min.js"></script>
</head>
<body>
    <h3>Diagnostic Control Panel</h3>
    <div id="controls">
        <button onclick="checkCapabilities()">1. Check Capabilities</button>
        <button onclick="testManualMultipart()">2. Test: Manual Multipart (Best Hope)</button>
        <button onclick="testV2Endpoint()">3. Test: V2 Endpoint Legacy</button>
    </div>
    <div id="log">Waiting for user input...</div>

<script>
    var dealId = null;
    const CONNECTION_NAME = "crmapi";

    // 1. INIT
    ZOHO.embeddedApp.on("PageLoad", function(data){
        if(data && data.EntityId) {
            dealId = Array.isArray(data.EntityId) ? data.EntityId[0] : data.EntityId;
            log("init", "Ready. Deal ID: " + dealId);
        }
    });
    ZOHO.embeddedApp.init();

    // 2. LOGGING HELPER
    function log(type, msg) {
        var el = document.getElementById("log");
        var color = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
        el.innerHTML += `<div class="${color}">[${type.toUpperCase()}] ${msg}</div>`;
        console.log("[" + type.toUpperCase() + "] " + msg);
    }

    // 3. CAPABILITY CHECK
    function checkCapabilities() {
        log("info", "Checking SDK methods...");
        if (ZOHO.CRM.API.httpRequest) log("success", "API.httpRequest is AVAILABLE");
        else log("error", "API.httpRequest is MISSING");
        
        if (ZOHO.CRM.CONNECTION.invoke) log("success", "CONNECTION.invoke is AVAILABLE");
        else log("error", "CONNECTION.invoke is MISSING");
    }

    // 4. TEST: MANUAL MULTIPART CONSTRUCTION (The Strategy)
    function testManualMultipart() {
        if (!dealId) return log("error", "No Deal ID");
        log("info", "Starting Manual Multipart Upload via Connection...");

        var content = "This is a test file uploaded via Manual Multipart Construction.";
        var fileName = "Manual_Test.txt";
        var boundary = "----ZohoWidgetBoundary" + Math.random().toString(36).substring(2);
        
        // Construct the Raw Multipart Body
        var body = "";
        body += "--" + boundary + "\r\n";
        body += 'Content-Disposition: form-data; name="file"; filename="' + fileName + '"\r\n';
        body += 'Content-Type: text/plain\r\n\r\n';
        body += content + "\r\n";
        body += "--" + boundary + "--";

        var reqData = {
            url: "https://www.zohoapis.com/crm/v2/Deals/" + dealId + "/Attachments",
            method: "POST",
            headers: {
                "Content-Type": "multipart/form-data; boundary=" + boundary
            },
            param_type: 2,
            body: body 
        };

        // Note: We send 'body' as a parameter assuming the connection handles raw bodies if configured right
        // If this fails, we know the Connection API blocks raw bodies.
        
        ZOHO.CRM.CONNECTION.invoke(CONNECTION_NAME, reqData)
        .then(function(data){
            log("info", "Response received.");
            if (JSON.stringify(data).indexOf("SUCCESS") > -1) {
                log("success", "UPLOAD SUCCESSFUL! We found the working method.");
                log("info", JSON.stringify(data));
            } else {
                log("error", "API Rejected: " + JSON.stringify(data));
            }
        })
        .catch(function(err){
            log("error", "Connection Failed: " + JSON.stringify(err));
        });
    }

    // 5. TEST: V2 LEGACY
    function testV2Endpoint() {
         log("info", "Testing V2 Endpoint with simple file wrapper...");
         var file = new File(["test"], "v2_test.txt", {type: "text/plain"});
         
         ZOHO.CRM.CONNECTION.invoke(CONNECTION_NAME, {
            url: "https://www.zohoapis.com/crm/v2/Deals/" + dealId + "/Attachments",
            method: "POST",
            param_type: 2,
            files: { file: file }
        })
        .then(function(data){
             log("info", "V2 Response: " + JSON.stringify(data));
        });
    }

</script>
</body>
</html>
