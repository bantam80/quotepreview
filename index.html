<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Questionnaire Gatekeeper</title>
    
    <script src="https://live.zwidgets.com/js-sdk/1.1/ZohoEmbededAppSDK.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f5f7; margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        
        /* Container fills the screen */
        .container { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            background: #fff; 
        }

        /* Header Styles */
        .header { 
            padding: 15px 20px; 
            background: #fff; 
            border-bottom: 2px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 50px;
        }
        .header h2 { margin: 0; color: #2c3e50; font-size: 18px; }
        .doc-info { text-align: right; font-size: 12px; color: #777; }

        /* Iframe Styles */
        #iframeContainer {
            flex-grow: 1; /* Takes remaining height */
            position: relative;
            width: 100%;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Loader Styles (Kept from your original file) */
        #loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 999; text-align: center; padding-top: 200px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Error Message Style */
        .error-msg { text-align: center; margin-top: 50px; color: #dc3545; font-weight: bold; display:none; padding: 20px;}
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><h3 id="loaderText">Processing...</h3></div>

    <div class="container">
        <div class="header">
            <h2>Form Completion Required</h2>
            <div class="doc-info">
                <div id="dealNameDisplay">Loading...</div>
                <div id="statusDisplay">Waiting for submission...</div>
            </div>
        </div>

        <div id="iframeContainer">
            <iframe id="formFrame" src=""></iframe>
            <div id="errorDisplay" class="error-msg"></div>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    // 1. The API Name of the URL field in the Deals module
    const URL_FIELD_API_NAME = "Questionnaire_Link"; 

    // 2. The Blueprint Transition ID to trigger upon success
    const PROCEED_TRANSITION_ID = "Proceed"; // Ensure this matches your Blueprint Button ID exactly

    // --- STATE ---
    var dealId = null;
    var dealRecord = null;

    // --- INIT ---
    ZOHO.embeddedApp.on("PageLoad", function(data){
        if(data && data.EntityId) {
            dealId = Array.isArray(data.EntityId) ? data.EntityId[0] : data.EntityId;
            initWidget();
        }
    });

    ZOHO.embeddedApp.init().then(function(){
        console.log("Zoho SDK Initialized");
    });

    function initWidget() {
        showLoader(true, "Loading Form...");
        
        // Fetch Deal Data to get the Link
        ZOHO.CRM.API.getRecord({ Entity: "Deals", RecordID: dealId })
        .then(function(response){
            if(response.data) {
                dealRecord = response.data[0];
                document.getElementById("dealNameDisplay").innerText = dealRecord.Deal_Name;
                
                // Load the Iframe
                loadIframe(dealRecord);
            }
        })
        .catch(function(err){
            showError("Failed to load Deal data: " + JSON.stringify(err));
        });
    }

    function loadIframe(record) {
        let url = record[URL_FIELD_API_NAME];

        if (url && url.startsWith("http")) {
            document.getElementById("formFrame").src = url;
            showLoader(false);
        } else {
            showError("No valid link found in field: " + URL_FIELD_API_NAME);
        }
    }

    function showError(msg) {
        showLoader(false);
        document.getElementById("formFrame").style.display = "none";
        let errDiv = document.getElementById("errorDisplay");
        errDiv.style.display = "block";
        errDiv.innerText = msg;
    }

    function showLoader(v, t) { 
        document.getElementById("loader").style.display = v?"block":"none";
        if(t) document.getElementById("loaderText").innerText = t; 
    }

    // --- LISTENER LOGIC (The "Magic") ---
    
    // This listens for the message sent by "thankyou.html"
    window.addEventListener("message", function(event) {
        
        // Security Check: You can uncomment the line below to restrict which domains can send messages
        // if (event.origin !== "https://forms.zohopublic.com") return;

        if (event.data === "FORM_SUBMITTED") {
            console.log("Form Submitted Signal Received!");
            handleSuccess();
        }
    }, false);

    async function handleSuccess() {
        showLoader(true, "Form Submitted. Advancing Blueprint...");

        // 1. Advance Blueprint
        try {
            await ZOHO.CRM.BLUEPRINT.proceed({ transition_id: PROCEED_TRANSITION_ID, data: {} });
            
            // 2. Success -> Close Popup & Refresh Parent Page
            document.getElementById("loaderText").innerText = "Done! Refreshing...";
            
            // Allow a brief moment for the transition to settle
            setTimeout(function() {
                ZOHO.CRM.UI.Popup.closeReload().then(function(){
                    // Fallback force open if closeReload doesn't trigger immediately
                    setTimeout(function(){
                         ZOHO.CRM.UI.Record.open({ Entity: "Deals", RecordID: dealId });
                    }, 500);
                });
            }, 1000);

        } catch (err) {
            console.error("Blueprint Error:", err);
            alert("Form submitted, but could not advance Blueprint.\n\nError: " + JSON.stringify(err));
            showLoader(false);
        }
    }

</script>
</body>
</html>
